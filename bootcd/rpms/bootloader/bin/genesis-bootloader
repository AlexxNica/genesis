#!/usr/bin/env ruby

require "rubygems"
require "retryingfetcher"
require "promptcli"

# Setup some pre-defined constants
GENESIS_ROOT = "/var/run/genesis"
GENESIS_STAGE2_SCRIPT = File.join(GENESIS_ROOT, "stage2.rb")

# Fetch our stage 2 URL
PROC_CMDLINE = (File.exists?("/proc/cmdline") && File.open("/proc/cmdline", "r") { |file| file.gets }) || ""
GENESIS_URL = PROC_CMDLINE[/GENESIS=([^ ]+)/, 1] || ENV['GENESIS_URL'] || "http://phil.ewr01.tumblr.net/genesis"
GENESIS_MODE = PROC_CMDLINE[/GENESIS_MODE=([^ ]+)/, 1] || ENV['GENESIS_MODE'] || "intake"
puts ""
puts "Genesis base URL is: %s" % [GENESIS_URL]
puts "Genesis operating mode is: %s" % [GENESIS_MODE]
puts "---"
puts ""

# Create our basic directory tree
Dir.mkdir(GENESIS_ROOT, 0755) unless File.directory? GENESIS_ROOT

syntax_valid = false
try_fetching = true

while !syntax_valid && try_fetching
  # fetch stage 2
  Genesis::RetryingFetcher.get("stage2/" + GENESIS_MODE, GENESIS_URL) {|data| File.open(GENESIS_STAGE2_SCRIPT, "w", 0755) { |file| file.puts data }}

  # verify stage 2
  syntax_valid = File.exists?(GENESIS_STAGE2_SCRIPT) && !!`ruby -c #{GENESIS_STAGE2_SCRIPT}`.strip.match(/^Syntax OK$/)
  
  if !syntax_valid
    puts "\n"
    try_fetching = Genesis::PromptCLI.ask "Genesis Stage 2 is corrupt. Would you like to retry?" 
    puts "\n"
  end
end

raise RuntimeError, msg + "Genesis Stage 2 is corrupt. Execution halted!" unless syntax_valid

# setup the environment
ENV['GENESIS_ROOT'] = GENESIS_ROOT
ENV['GENESIS_URL'] = GENESIS_URL 

# Execute the stage 2
puts "\nSwitching to '" + GENESIS_ROOT + "' and executing stage 2..."
Kernel.exec("cd " + GENESIS_ROOT + "; /usr/bin/env ruby " + GENESIS_STAGE2_SCRIPT)
